name: CI/CD

on:
  push:
    branches:
      - "*"

jobs:
  build:
    runs-on: self-hosted

    steps:
      - name: Checkout code
        uses: actions/checkout@v2
        with:
          node-version: 16

      - name: Build App
        run: |
          echo "Start building App"
          npm install
          npm run build
          echo "Build successfully!"

      - name: Upload Build Artifacts
        uses: actions/upload-artifact@v2
        with:
          name: build
          path: build

  deploy:
    runs-on: self-hosted
    if: github.ref == 'refs/heads/main'  # Run this job only if the branch is main

    steps:
      - name: Checkout code
        uses: actions/checkout@v2
        with:
          node-version: 16

      - name: Download Build Artifacts
        uses: actions/download-artifact@v2
        with:
          name: build
          path: /home/ubuntu/actions-runner/_work/Company-page/Company-page/build  # Update this path accordingly

      - name: Deploy to EC2
        uses: appleboy/scp-action
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          source: "/home/ubuntu/actions-runner/_work/Company-page/Company-page/build/"
          target: "/path/to/your/web/server/directory"

      - name: SSH into EC2 and restart server
        uses: appleboy/ssh-action
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            sudo systemctl restart nginx  # Adjust this command based on your setup
